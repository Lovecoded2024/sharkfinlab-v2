// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. 股票基础信息表
model StockBasic {
  id          Int      @id @default(autoincrement())
  tsCode      String   @unique @map("ts_code")
  symbol      String
  name        String
  area        String?
  industry    String?
  fullname    String?
  enname      String?
  cnspell     String?
  market      String?  // 主板/创业板/科创板/北交所
  exchange    String?  // SSE/SZSE
  currType    String?  @map("curr_type")
  listStatus  String?  @map("list_status")
  listDate    DateTime? @map("list_date")
  delistDate  DateTime? @map("delist_date")
  isHs        String?  @map("is_hs")
  isSt        Boolean  @default(false) @map("is_st")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  quotes      DailyQuote[]
  technicals  TechnicalIndicator[]
  financials  FinancialIndicator[]

  @@map("stock_basic")
}

// 2. 日线行情表
model DailyQuote {
  id         Int      @id @default(autoincrement())
  tsCode     String   @map("ts_code")
  tradeDate  DateTime @map("trade_date")
  open       Decimal? @db.Decimal(12, 4)
  high       Decimal? @db.Decimal(12, 4)
  low        Decimal? @db.Decimal(12, 4)
  close      Decimal? @db.Decimal(12, 4)
  preClose   Decimal? @map("pre_close") @db.Decimal(12, 4)
  change     Decimal? @db.Decimal(12, 4)
  pctChg     Decimal? @map("pct_chg") @db.Decimal(8, 4)
  vol        BigInt?
  amount     Decimal? @db.Decimal(20, 4)
  createdAt  DateTime @default(now()) @map("created_at")

  stock      StockBasic @relation(fields: [tsCode], references: [tsCode])

  @@unique([tsCode, tradeDate])
  @@index([tsCode])
  @@index([tradeDate])
  @@map("daily_quotes")
}

// 3. 财务指标表
model FinancialIndicator {
  id                      Int      @id @default(autoincrement())
  tsCode                  String   @map("ts_code")
  annDate                 DateTime? @map("ann_date")
  endDate                 DateTime @map("end_date")
  eps                     Decimal? @db.Decimal(12, 4)
  dtEps                   Decimal? @map("dt_eps") @db.Decimal(12, 4)
  totalRevenue            Decimal? @map("total_revenue") @db.Decimal(20, 4)
  revenue                 Decimal? @db.Decimal(20, 4)
  totalProfit             Decimal? @map("total_profit") @db.Decimal(20, 4)
  netProfit               Decimal? @map("net_profit") @db.Decimal(20, 4)
  totalHldrEqyExcMinInt   Decimal? @map("total_hldr_eqy_exc_min_int") @db.Decimal(20, 4)
  dilutedRoe              Decimal? @map("diluted_roe") @db.Decimal(8, 4)
  dilutedRoeDt            Decimal? @map("diluted_roe_dt") @db.Decimal(8, 4)
  grossprofitMargin       Decimal? @map("grossprofit_margin") @db.Decimal(8, 4)
  netprofitMargin         Decimal? @map("netprofit_margin") @db.Decimal(8, 4)
  debtToAssets            Decimal? @map("debt_to_assets") @db.Decimal(8, 4)
  currentRatio            Decimal? @map("current_ratio") @db.Decimal(8, 4)
  quickRatio              Decimal? @map("quick_ratio") @db.Decimal(8, 4)
  inventoryTurnover       Decimal? @map("inventory_turnover") @db.Decimal(8, 4)
  arTurnover              Decimal? @map("ar_turnover") @db.Decimal(8, 4)
  assetsTurnover          Decimal? @map("assets_turnover") @db.Decimal(8, 4)
  roe                     Decimal? @db.Decimal(8, 4)
  roeWaa                  Decimal? @map("roe_waa") @db.Decimal(8, 4)
  roeDt                   Decimal? @map("roe_dt") @db.Decimal(8, 4)
  roeAvg                  Decimal? @map("roe_avg") @db.Decimal(8, 4)
  opYoy                   Decimal? @map("op_yoy") @db.Decimal(8, 4)
  ebtYoy                  Decimal? @map("ebt_yoy") @db.Decimal(8, 4)
  trYoy                   Decimal? @map("tr_yoy") @db.Decimal(8, 4)
  orYoy                   Decimal? @map("or_yoy") @db.Decimal(8, 4)
  equityYoy               Decimal? @map("equity_yoy") @db.Decimal(8, 4)
  updateFlag              String?  @map("update_flag")
  createdAt               DateTime @default(now()) @map("created_at")

  stock                   StockBasic @relation(fields: [tsCode], references: [tsCode])

  @@unique([tsCode, endDate, updateFlag])
  @@index([tsCode])
  @@index([endDate])
  @@map("financial_indicators")
}

// 4. 技术指标表
model TechnicalIndicator {
  id          Int      @id @default(autoincrement())
  tsCode      String   @map("ts_code")
  tradeDate   DateTime @map("trade_date")
  
  // 均线系统
  ma5         Decimal? @db.Decimal(12, 4)
  ma10        Decimal? @db.Decimal(12, 4)
  ma20        Decimal? @db.Decimal(12, 4)
  ma30        Decimal? @db.Decimal(12, 4)
  ma60        Decimal? @db.Decimal(12, 4)
  ma120       Decimal? @db.Decimal(12, 4)
  ma250       Decimal? @db.Decimal(12, 4)
  
  // RSI
  rsi6        Decimal? @map("rsi_6") @db.Decimal(8, 4)
  rsi12       Decimal? @map("rsi_12") @db.Decimal(8, 4)
  rsi14       Decimal? @map("rsi_14") @db.Decimal(8, 4)
  rsi24       Decimal? @map("rsi_24") @db.Decimal(8, 4)
  
  // MACD
  macdDif     Decimal? @map("macd_dif") @db.Decimal(12, 4)
  macdDea     Decimal? @map("macd_dea") @db.Decimal(12, 4)
  macdBar     Decimal? @map("macd_bar") @db.Decimal(12, 4)
  
  // 布林带
  bbUpper     Decimal? @map("bb_upper") @db.Decimal(12, 4)
  bbMiddle    Decimal? @map("bb_middle") @db.Decimal(12, 4)
  bbLower     Decimal? @map("bb_lower") @db.Decimal(12, 4)
  
  // KDJ
  kdjK        Decimal? @map("kdj_k") @db.Decimal(8, 4)
  kdjD        Decimal? @map("kdj_d") @db.Decimal(8, 4)
  kdjJ        Decimal? @map("kdj_j") @db.Decimal(8, 4)
  
  // 成交量指标
  volMa5      BigInt?  @map("vol_ma5")
  volMa10     BigInt?  @map("vol_ma10")
  volMa20     BigInt?  @map("vol_ma20")
  
  // 其他指标
  atr14       Decimal? @map("atr_14") @db.Decimal(12, 4)
  cci14       Decimal? @map("cci_14") @db.Decimal(12, 4)
  obv         Decimal? @db.Decimal(20, 4)
  
  createdAt   DateTime @default(now()) @map("created_at")

  stock       StockBasic @relation(fields: [tsCode], references: [tsCode])

  @@unique([tsCode, tradeDate])
  @@index([tsCode])
  @@index([tradeDate])
  @@map("technical_indicators")
}

// 5. Agent 账户表
model AgentAccount {
  id              Int      @id @default(autoincrement())
  agentId         String   @unique @map("agent_id")
  agentName       String   @map("agent_name")
  agentType       String?  @map("agent_type")
  description     String?
  config          Json?
  systemPrompt    String?  @map("system_prompt")
  
  // 资金信息
  initialCapital  Decimal  @default(1000000) @map("initial_capital") @db.Decimal(15, 2)
  currentCash     Decimal  @default(1000000) @map("current_cash") @db.Decimal(15, 2)
  totalValue      Decimal  @default(1000000) @map("total_value") @db.Decimal(15, 2)
  
  // 绩效指标
  totalReturn     Decimal  @default(0) @map("total_return") @db.Decimal(8, 4)
  annualReturn    Decimal? @map("annual_return") @db.Decimal(8, 4)
  sharpeRatio     Decimal? @map("sharpe_ratio") @db.Decimal(8, 4)
  maxDrawdown     Decimal? @map("max_drawdown") @db.Decimal(8, 4)
  volatility      Decimal? @db.Decimal(8, 4)
  winRate         Decimal? @map("win_rate") @db.Decimal(8, 4)
  
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  positions       AgentPosition[]
  trades          TradeRecord[]
  dailyNavs       DailyNav[]

  @@map("agent_accounts")
}

// 6. Agent 持仓表
model AgentPosition {
  id              Int      @id @default(autoincrement())
  agentId         String   @map("agent_id")
  tsCode          String   @map("ts_code")
  name            String?
  
  volume          Int      @default(0)
  availableVolume Int      @default(0) @map("available_volume")
  avgCost         Decimal  @default(0) @map("avg_cost") @db.Decimal(12, 4)
  currentPrice    Decimal  @default(0) @map("current_price") @db.Decimal(12, 4)
  marketValue     Decimal  @default(0) @map("market_value") @db.Decimal(15, 2)
  
  totalPnl        Decimal  @default(0) @map("total_pnl") @db.Decimal(15, 2)
  unrealizedPnl   Decimal  @default(0) @map("unrealized_pnl") @db.Decimal(15, 2)
  realizedPnl     Decimal  @default(0) @map("realized_pnl") @db.Decimal(15, 2)
  pnlPct          Decimal  @default(0) @map("pnl_pct") @db.Decimal(8, 4)
  
  buyCount        Int      @default(0) @map("buy_count")
  sellCount       Int      @default(0) @map("sell_count")
  firstBuyDate    DateTime? @map("first_buy_date")
  lastTradeDate   DateTime? @map("last_trade_date")
  
  updatedAt       DateTime @updatedAt @map("updated_at")

  agent           AgentAccount @relation(fields: [agentId], references: [agentId])

  @@unique([agentId, tsCode])
  @@index([agentId])
  @@index([tsCode])
  @@map("agent_positions")
}

// 7. 交易记录表
model TradeRecord {
  id              Int      @id @default(autoincrement())
  agentId         String   @map("agent_id")
  tradeDate       DateTime @map("trade_date")
  tsCode          String   @map("ts_code")
  name            String?
  
  tradeType       String   @map("trade_type") // BUY/SELL
  volume          Int
  price           Decimal  @db.Decimal(12, 4)
  amount          Decimal  @db.Decimal(15, 2)
  
  commission      Decimal  @default(0) @db.Decimal(10, 2)
  tax             Decimal  @default(0) @db.Decimal(10, 2)
  transferFee     Decimal  @default(0) @map("transfer_fee") @db.Decimal(10, 2)
  totalCost       Decimal? @map("total_cost") @db.Decimal(15, 2)
  
  realizedPnl     Decimal? @map("realized_pnl") @db.Decimal(15, 2)
  pnlPct          Decimal? @map("pnl_pct") @db.Decimal(8, 4)
  
  decisionReason  String?  @map("decision_reason")
  thinkingChain   Json?    @map("thinking_chain")
  confidence      Decimal? @db.Decimal(4, 3)
  
  status          String   @default("filled")
  createdAt       DateTime @default(now()) @map("created_at")

  agent           AgentAccount @relation(fields: [agentId], references: [agentId])

  @@index([agentId])
  @@index([tradeDate])
  @@index([tsCode])
  @@index([agentId, tradeDate])
  @@map("trade_records")
}

// 8. 每日净值记录
model DailyNav {
  id                Int      @id @default(autoincrement())
  agentId           String   @map("agent_id")
  tradeDate         DateTime @map("trade_date")
  
  nav               Decimal  @db.Decimal(12, 6)
  totalValue        Decimal  @map("total_value") @db.Decimal(15, 2)
  cash              Decimal  @db.Decimal(15, 2)
  marketValue       Decimal  @default(0) @map("market_value") @db.Decimal(15, 2)
  
  dailyReturn       Decimal? @map("daily_return") @db.Decimal(8, 4)
  dailyPnl          Decimal? @map("daily_pnl") @db.Decimal(15, 2)
  cumulativeReturn  Decimal? @map("cumulative_return") @db.Decimal(8, 4)
  
  positionCount     Int      @default(0) @map("position_count")
  positionRatio     Decimal? @map("position_ratio") @db.Decimal(8, 4)
  
  createdAt         DateTime @default(now()) @map("created_at")

  agent             AgentAccount @relation(fields: [agentId], references: [agentId])

  @@unique([agentId, tradeDate])
  @@index([agentId])
  @@index([tradeDate])
  @@map("daily_nav")
}

// 9. 任务执行日志表
model JobLog {
  id            Int      @id @default(autoincrement())
  jobName       String   @map("job_name")
  jobType       String?  @map("job_type")
  status        String?
  startTime     DateTime? @map("start_time")
  endTime       DateTime? @map("end_time")
  durationMs    Int?     @map("duration_ms")
  params        Json?
  result        Json?
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([jobName])
  @@index([createdAt])
  @@map("job_logs")
}

// 10. 数据更新记录表
model DataUpdateLog {
  id            Int      @id @default(autoincrement())
  dataType      String   @map("data_type")
  tradeDate     DateTime? @map("trade_date")
  startDate     DateTime? @map("start_date")
  endDate       DateTime? @map("end_date")
  recordCount   Int?     @map("record_count")
  status        String?
  message       String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("data_update_logs")
}
